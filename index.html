<!DOCTYPE html>
<html>
<head>
  <title>TrustDoc</title>

  <!-- Supabase browser build -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 40px;
      text-align: center;
      background: #f7f9fb;
      color: #0A2540;
    }

    input, button {
      padding: 10px;
      margin: 6px;
      width: 260px;
    }

    button {
      cursor: pointer;
      background: #0A2540;
      color: white;
      border: none;
    }

    button:hover {
      background: #163a6b;
    }

    .box {
      max-width: 420px;
      margin: auto;
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }
  </style>
</head>
<body>

<!-- üîê AUTH SECTION -->
<div id="auth" class="box">
  <h1>TrustDoc</h1>
  <p>Secure your important PDFs and verify them anytime.</p>

  <input id="email" type="email" placeholder="Email"><br>
  <input id="password" type="password" placeholder="Password"><br>

  <button onclick="signUp()">Sign Up</button><br>
  <button onclick="signIn()">Login</button>
</div>

<!-- ‚úÖ APP SECTION (HIDDEN BY DEFAULT) -->
<div id="app" class="box" style="display:none;">
  <h2>Welcome to TrustDoc ‚úÖ</h2>
  <p>Upload a PDF to secure and verify it.</p>

  <input type="file" id="pdfFile" accept="application/pdf"><br>
  <button onclick="uploadPDF()">Upload PDF</button>

  <div id="uploadStatus"></div>

  <h3>Your Documents</h3>
  <ul id="docList"></ul>

  <button onclick="logout()">Logout</button>
    Soon you will be able to:
    <br>üîê Upload PDFs
    <br>üîé Verify documents
    <br>üìÑ Share proof links
  </p>

  <button onclick="logout()">Logout</button>
</div>

<script>
  const supabaseClient = window.supabase.createClient(
    "https://cdhixtigmdszjkpbmzhs.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNkaGl4dGlnbWRzemprcGJtemhzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY3NzcwMDgsImV4cCI6MjA4MjM1MzAwOH0.PAuVbbvHIMmHX9RC-_sQcoCaXg07rHYd_SbeDjVHNto"
  );

  async function signUp() {
    const email = emailInput();
    const password = passwordInput();

    const { error } = await supabaseClient.auth.signUp({ email, password });
    alert(error ? error.message : "Signup successful! You can now login.");
  }

  async function signIn() {
    const email = emailInput();
    const password = passwordInput();

    const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
    if (error) alert(error.message);
    else showApp();
  }

  async function logout() {
    await supabaseClient.auth.signOut();
    location.reload();
  }

  function showApp() {
    document.getElementById("auth").style.display = "none";
    document.getElementById("app").style.display = "block";
  }

  function emailInput() {
    return document.getElementById("email").value;
  }

  function passwordInput() {
    return document.getElementById("password").value;
  }

  supabaseClient.auth.getSession().then(({ data }) => {
    if (data.session) showApp();
  });
</script>

</body>
</html>
<script>
  async function uploadPDF() {
    const fileInput = document.getElementById("pdfFile");
    const status = document.getElementById("uploadStatus");

    if (!fileInput.files.length) {
      alert("Please select a PDF file");
      return;
    }

    const file = fileInput.files[0];

    if (file.type !== "application/pdf") {
      alert("Only PDF files are allowed");
      return;
    }

    status.innerText = "Uploading...";

    const { data: sessionData } = await supabaseClient.auth.getSession();
    const user = sessionData.session.user;

    const filePath = `${user.id}/${Date.now()}_${file.name}`;

    const { error: uploadError } = await supabaseClient
      .storage
      .from("documents")
      .upload(filePath, file);

    if (uploadError) {
      status.innerText = uploadError.message;
      return;
    }

    const { data: urlData } = supabaseClient
      .storage
      .from("documents")
      .getPublicUrl(filePath);

    const verificationCode =
      "TD-" + Math.random().toString(36).substring(2, 8).toUpperCase();

    const { error: dbError } = await supabaseClient
      .from("documents")
      .insert({
        user_id: user.id,
        file_name: file.name,
        file_url: urlData.publicUrl,
        verification_code: verificationCode
      });

    if (dbError) {
      status.innerText = dbError.message;
      return;
    }

    status.innerHTML =
      "‚úÖ Uploaded successfully<br>Verification Code: <b>" + verificationCode + "</b>";

    loadDocuments();
  }

  async function loadDocuments() {
    const list = document.getElementById("docList");
    list.innerHTML = "";

    const { data: sessionData } = await supabaseClient.auth.getSession();
    const user = sessionData.session.user;

    const { data, error } = await supabaseClient
      .from("documents")
      .select("*")
      .eq("user_id", user.id)
      .order("created_at", { ascending: false });

    if (error) return;

    data.forEach(doc => {
      const li = document.createElement("li");
      li.innerHTML = `
        üìÑ ${doc.file_name}<br>
        üîê Code: <b>${doc.verification_code}</b>
      `;
      list.appendChild(li);
    });
  }

  // Load documents when logged in
  supabaseClient.auth.getSession().then(({ data }) => {
    if (data.session) loadDocuments();
  });
</script>
